<!DOCTYPE html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

<title>Throw a bottle</title>

<!-- Mobile viewport optimization h5bp.com/ad -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


<!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-touch-fullscreen" content="yes" />
  
<!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
<meta http-equiv="cleartype" content="on">
  
<link rel="stylesheet/less" type="text/css" href="style.less" />
<script src="less.js"></script>

</head>
<body>

<!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>



<script type="text/javascript">
var mobile = (/iphone|ipad|ipod|android|blackberry|mini|windows\sce|palm/i.test(navigator.userAgent.toLowerCase()));
//append background
$('body').append('<img src="images/'+(mobile ? 'bg/lowv.png' : 'background.svg')+'" alt="" class="fullscreen" id="background">');
var netCount = 3;
var bottleCount = 6;








function toggle(x) {
	//IE8 no opacity support :(
	if ( $.browser.msie && $.browser.version < 9) {
		if($('#dimmer').css('display') === 'none')
			$('#dimmer').css('display','block');
		else
			$('#dimmer').css('display','none');
	}
	else $('#dimmer').fadeToggle('slow',function(){});
	$(x).slideToggle('slow',function(){});
}


</script>





<img src="images/cloud.png" alt="" id="cloud3"/>
<img src="images/cloud.png" alt="" id="cloud2"/>
<img src="images/cloud.png" alt="" id="cloud1"/>
<img src="images/sun3.png" alt="" style="position:fixed;margin-left:-46px;left:50%;top:20px;width:92px;height:92px;"/>

<div class="side_note" id="btn_bottle_counter">6</div>
<img src="images/bottle5.png" alt="" class="side_button left_side" id="btn_bottle"/>

<div class="side_note" id="btn_net_counter">3</div>
<img src="images/net2.png" alt="" class="side_button left_side" id="btn_net"/>


<img src="images/chest.png" alt="" class="side_button right_side" id="btn_history"/>
<div id="notifications"></div>

<script type="text/javascript"> 
function cloud1(){  
    $("#cloud1").animate({left:"+=120%"},49000,'linear',function(){ $('#cloud1').css('left','-120px'); });  
    setTimeout("cloud1()",49000);  
}  
function cloud2(){  
    $("#cloud2").animate({left:"+=120%"},39000,'linear',function(){ $('#cloud2').css('left','-120px'); }); 
    setTimeout("cloud2()",39000);  
}  
function cloud3(){  
    $("#cloud3").animate({left:"+=120%"},34000,'linear',function(){ $('#cloud3').css('left','-120px'); });
    setTimeout("cloud3()",34000);  
}  
function animate(){
    cloud1();  
    cloud2(); 
	cloud3();
}
//setTimeout("animate()",300);
</script>


<!-- JavaScript at the bottom for fast page loading -->

<!-- scripts concatenated and minified via ant build script -->
<script src="js/helper.js"></script>
<script src="js/libs/iscroll.js"></script>

<script>

 //iPhone Scale Bug Fix, read this when using http://www.blog.highub.com/mobile-2/a-fix-for-iphone-viewport-scale-bug/
 MBP.scaleFix();
 MBP.hideUrlBar();
 //MBP.preventZoom();



 var ids=0;

 $('body').bind('ajaxError',function(request,status,error){
     alert('Ajax error: '  + status.statusText);
 });

 //base popup
 function PopupBase(title,body){
     this.id='_'+ids;ids++;
     $('body').append('<div class="fullscreen popup" id="'+this.id+'"><h3>'+title+'</h3>'+body+'</div>');
 }
 PopupBase.prototype.close = function(){
     $('#'+this.id).fadeOut('slow');
     return this;
 }
 PopupBase.prototype.show = function(){
     $('#'+this.id).fadeIn('slow');
     return this;
 }
 PopupBase.prototype.transition = function(other){
     $('#'+this.id).fadeOut('slow');
     $('#'+other.id).fadeIn('slow');
     return this;
 }

 //scrollable
 ScrollablePopup.prototype = new PopupBase;
 ScrollablePopup.prototype.constructor = PopupBase;
 function ScrollablePopup(title,body){
     this.id='_'+ids;ids++;
     this.iscroll = true;
     this.scrollbar = null;

     var src = this.iscroll ? '<div class="fullscreen popup" id="'+this.id+'"><h3>'+title+'</h3>'+
             '<div class="taWrapper" id="messagesWrapper"><ul id="data'+this.id+'"></ul></div>'+body+'</div>' :
             '<div class="scrollablePopup" id="'+this.id+'"><div class="fullscreen popup" id="i'+this.id+'" style="display:block;"><h3>'+title+'</h3>'+
             '<div class="taWrapper" id="messagesWrapper"><ul id="data'+this.id+'"></ul></div>'+body+'</div></div>';

     $('body').append(src);
 }

 document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
 $(window).scroll(function (){
     var s = $(window).scrollTop();
     $('#messagesWrapper').scrollTop(s);
 });

 ScrollablePopup.prototype.show = function(){
     if(this.iscroll){
         var s = this.scrollbar = new iScroll('messagesWrapper',{hScroll:false,hScrollbar:false});
         setTimeout(function() { s.refresh(); },0);
     }
     $('#'+this.id).fadeIn('slow');
     return this;
 }
 ScrollablePopup.prototype.close = function(){
     $('#'+this.id).fadeOut('slow');
     if(this.scrollbar){
         try{
             this.scrollbar.destroy();
         }
         catch(exp){
         }
         this.scrollbar = null;
     }
     return this;
 }
 ScrollablePopup.prototype.update= function(data,nodeCreator){
     var id = 0;
     var h = 0 , node;
     var container = $('#data'+this.id);
     var idPrefix=this.id+'_';

      data.forEach(function(elem){
         node = nodeCreator(elem.m,idPrefix+id);
         container.append(node.html);
         id++;
         h+=node.height;
         $('#'+idPrefix+id).click(function(){
             alert('m:hha');
         });
     });
     if(!this.iscroll) $('#'+this.id).height(h+100);
 }

 //normal popups
 Popup.prototype = new PopupBase;
 Popup.prototype.constructor = PopupBase;
 function Popup(title,body){
     PopupBase.call(this,title,'<div class="popupWrapper">'+body+'</div>');
 }

 //one big textarea popup
 MessagePopup.prototype = new PopupBase;
 MessagePopup.prototype.constructor = PopupBase;
 function MessagePopup(title,buttons,settings){
     settings = settings == null ? {} : settings;
     this.buttons = buttons;

     var extras = settings.readonly ? ' readonly' : '';
     PopupBase.call(this,title,'<form><div class="taWrapper"><div><textarea name="m" id="msg_'+ids+'" maxlength="500" required'+extras+'></textarea></div></div>' +
             '<div class="inputButtons"><input type="button" value="'+buttons[0].text+'" onClick="'+buttons[0].action+';"/>'+
             '<input type="button" value="'+buttons[1].text+'" onClick="'+buttons[1].action+';"/></div></form>');
 }
 MessagePopup.prototype.send = function(url,handler){
     this.close();
     if(handler) $.post(url, $('#msg'+this.id).serialize() ,handler,'json');
     else $.post(url, $('#msg'+this.id).serialize());
     $('#msg'+this.id).val('');
     return this;
 }
 MessagePopup.prototype.setText = function(text){
     $('#msg'+this.id).val(text);
     return this;
 }




 function bottleSent(data){
     if(data.r >= 0){
         bottleCount = data.r;
         $('#btn_bottle_counter').html(bottleCount.toString());
     }
     else alert('Bottle failed sending! Error:' + data.error);
 }

 var welcome = new Popup('Welcome',
         '<p>What is throw a bottle? It is a simple service which allows you to throw anonymous bottles into the sea.</p>' + //'<p>This will be the main welcome page. In here the user will be asked to sign in. We also will have a description and shit</p>' +
         '<button type="button" class="centeredButton" onClick="welcome.transition(signin);">Sign in</button>' +
         '<button type="button" class="centeredButton" onClick="welcome.transition(registration);">Register</button>' +
         '<button type="button" class="centeredButton" id="facebook_signin">Sign in with facebook</button>');

 $('#facebook_signin').click(function(){
     window.location.href = 'https://www.facebook.com/dialog/oauth/?client_id=233473013410744&display='+(mobile ? 'touch' : 'page')+'&redirect_uri=http%3A%2F%2F199.30.59.142%2Fapi%2Ffblogin&response_type=code';
 });

 var signin = new Popup('Log In','<form id="loginForm">' +
         '<label for="userid">User ID:</label>' +
         '<input type="text" id="loginUser" name="userid" required autocapitalize="off"/>' +
          '<label for="password">Password:</label>'+
          '<input type="password" id="loginPassword" name="password" required autocapitalize="off"/>' +
          '<input type="submit" style="float:none;margin:20px auto" value="Log in"/></form>');

 var registration = new Popup('Register','<form id="registrationForm">' +
         '<label for="userid">User ID:</label>' +
         '<input type="text" id="loginUser" name="userid" required autocapitalize="off"/>' +
         '<label for="password">Password:</label>'+
         '<input type="password" id="loginPassword" name="password" required autocapitalize="off"/>' +
         '<input type="submit" style="float:none;margin:20px auto" value="Log in"/></form>');

 var messages = new ScrollablePopup('Messages','<div class="inputButtons"><button type="button" style="float:none;margin:10px auto" onClick="messages.close();">Ok</button></div>');



 messages.update([{m:'foo'},{m:'bar'},{m:'kR%H H JR%\n5uytrjhgr rggh\nrgjhr rjghj5hjg 5jhghj\n5uytrjhgr rggh rgjhr rjghj5hjg 5jhghj'},{m:'lol'},{m:'test'},{m:'lol'},{m:'test'}],
 function(msg,id){
     return { html:'<li id="'+id+'">'+msg+'</li>', height:43 };
 });


 $('#loginForm').submit(function(){
     var userid = $('#loginUser').val();
     var password = $('#loginPassword').val();
     $.post('api/login','userid='+userid+'&pwd='+password,function(response){
         if(response.r === 0){
             handleQuery(response);
             signin.close();
         }
         else alert('Wrong username or password!');
     },'json');
     return false;
 });

 $('#registrationForm').submit(function(){
     var userid = $('#loginUser').val();
     var password = $('#loginPassword').val();
     $.post('api/register','userid='+userid+'&pwd='+password,function(response){
         if(response.r === 0){
             handleQuery(response);
             registration.close();
         }
         else alert('This username is already taken!');
     },'json');
     return false;
 });


 var newBottle = new MessagePopup('Say something:',[{text:'never mind',action:'newBottle.close()'},{text:'throw!',action:'$(\'#btn_bottle_counter\').html((bottleCount-1).toString());newBottle.send(\'api/throw\',bottleSent)'}]);

 var recievedBottle = new MessagePopup('Bottle:',[{text:'throw back',action:'recievedBottle.close();$.get(\'api/bottle/recycle\');'},{text:'reply',action:'recievedBottle.transition(replyToBottle)'}],{readonly:true});

 var replyToBottle = new MessagePopup('Reply:',[{text:'cancel',action:'replyToBottle.close();$.get(\'api/bottle/recycle\');'},{text:'send reply',action:'replyToBottle.send(\'api/bottle/reply\')'}]);

 $('#btn_bottle').click(function(){
     if(bottleCount === 0) alert('No more bottles remaining!');
     else newBottle.show();
 });

 $('#btn_net').click(function(){
     function bottleCaught(data){
         if(data.r >= 0){
             netCount = data.r;
             if(data.m){
                 $('#btn_net_counter').html(netCount.toString());
                 recievedBottle.setText(data.m).show();
             }else alert("You've caught some " + data.j);
         }
         else alert('Bottle failed catching! Error:' + data.error);
     }

     if(netCount === 0) alert('No more nets remaining!');
     else{
         $('#btn_net_counter').html((netCount-1).toString());
         $.get('api/catch',bottleCaught,'json');
     }
 });


 var notifications = $('#notifications');
 notifications.count = function(n){
     if(n > 0){
         this.html(n.toString());
         this.show();
     }else this.hide();
 }

 $('#btn_history').click(function(){
     notifications.count(0);
     messages.show();
 });

 function handleQuery(response){
     if(response.r === 0){
         bottleCount = response.b;
         $('#btn_bottle_counter').html(bottleCount.toString());
         netCount = response.n;
         $('#btn_net_counter').html(netCount.toString());
         notifications.count(response.e ? response.e : 0);
     }
     else welcome.show();
 }

 //poll the server for updates
 var isActive = true;
 window.onfocus = function () {
     isActive = true;
 }
 window.onblur = function () {
     isActive = false;
 }
 function query(){
     if(isActive){
        $.get('api/query',handleQuery);
     }
     setTimeout(query,5 * 60 * 1000);
 }

 $(document).ready(function(){
     query();

 });


</script>

</body>
</html>


