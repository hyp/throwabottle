<!DOCTYPE html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

<title>Throw a bottle</title>

<!-- Mobile viewport optimization h5bp.com/ad -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


<!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-touch-fullscreen" content="yes" />
  
<!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
<meta http-equiv="cleartype" content="on">
  
<link rel="stylesheet/less" type="text/css" href="style.less" />
<script src="less.js"></script>

</head>
<body>

<!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>



<script type="text/javascript">
var mobile = (/iphone|ipad|ipod|android|blackberry|mini|windows\sce|palm/i.test(navigator.userAgent.toLowerCase()));
//append background
$('body').append('<img src="images/'+(mobile ? 'bg/lowv.png' : 'background.svg')+'" alt="" class="fullscreen" id="background">');
var netCount = 3;
var bottleCount = 6;








function toggle(x) {
	//IE8 no opacity support :(
	if ( $.browser.msie && $.browser.version < 9) {
		if($('#dimmer').css('display') === 'none')
			$('#dimmer').css('display','block');
		else
			$('#dimmer').css('display','none');
	}
	else $('#dimmer').fadeToggle('slow',function(){});
	$(x).slideToggle('slow',function(){});
}


</script>





<img src="images/cloud.png" alt="" id="cloud3"/>
<img src="images/cloud.png" alt="" id="cloud2"/>
<img src="images/cloud.png" alt="" id="cloud1"/>
<img src="images/sun3.png" alt="" style="position:fixed;margin-left:-46px;left:50%;top:20px;width:92px;height:92px;"/>

<div class="side_note" id="btn_bottle_counter">6</div>
<img src="images/bottle5.png" alt="" class="side_button left_side" id="btn_bottle"/>

<div class="side_note" id="btn_net_counter">3</div>
<img src="images/net2.png" alt="" class="side_button left_side" id="btn_net"/>


<img src="images/chest.png" alt="" class="side_button right_side" id="btn_history"/>
<div id="notifications"></div>

<script type="text/javascript"> 
function cloud1(){  
    $("#cloud1").animate({left:"+=120%"},49000,'linear',function(){ $('#cloud1').css('left','-120px'); });  
    setTimeout("cloud1()",49000);  
}  
function cloud2(){  
    $("#cloud2").animate({left:"+=120%"},39000,'linear',function(){ $('#cloud2').css('left','-120px'); }); 
    setTimeout("cloud2()",39000);  
}  
function cloud3(){  
    $("#cloud3").animate({left:"+=120%"},34000,'linear',function(){ $('#cloud3').css('left','-120px'); });
    setTimeout("cloud3()",34000);  
}  
function animate(){
    cloud1();  
    cloud2(); 
	cloud3();
}
//setTimeout("animate()",300);
</script>


<!-- JavaScript at the bottom for fast page loading -->

<!-- scripts concatenated and minified via ant build script -->
<script src="js/helper.js"></script>
<script src="js/libs/iscroll.js"></script>

<script>

 //iPhone Scale Bug Fix, read this when using http://www.blog.highub.com/mobile-2/a-fix-for-iphone-viewport-scale-bug/
 if(mobile){
     MBP.scaleFix();
     MBP.hideUrlBar();
 }
 //MBP.preventZoom();



 var ids=0;

 $('body').bind('ajaxError',function(request,status,error){
     alert('Ajax error: '  + status.statusText);
 });

 //base popup
 function PopupBase(title,body){
     this.id='_'+ids;ids++;
     $('body').append('<div class="fullscreen popup" id="'+this.id+'"><h3>'+title+'</h3>'+body+'</div>');
 }
 PopupBase.prototype.close = function(){
     $('#'+this.id).fadeOut('slow');
     return this;
 }
 PopupBase.prototype.show = function(){
     $('#'+this.id).fadeIn('slow');
     return this;
 }
 PopupBase.prototype.transition = function(other){
     $('#'+this.id).fadeOut('slow');
     $('#'+other.id).fadeIn('slow');
     return this;
 }

 //scrollable
 ScrollablePopup.prototype = new PopupBase;
 ScrollablePopup.prototype.constructor = PopupBase;
 var useIscroll = true;//mobile;
 function ScrollablePopup(title,body,innerBody){
     innerBody = innerBody ? innerBody : '';
     this.id='_'+ids;ids++;
     this.iscroll = useIscroll;
     this.scrollbar = null;

     var src = this.iscroll ? '<div class="fullscreen popup" id="'+this.id+'"><h3>'+title+'</h3>'+
             '<div class="taWrapper" style="background: transparent;"><div class="popup-top popup-background"></div><div class="popup-bottom popup-background "></div><div class="popup-middle popup-background"><div class="popup-scrollableArea" id="scroll'+this.id+'"><ul id="data'+this.id+'"></ul></div></div>'+innerBody+'</div>'+body+'</div>' :
             '<div class="scrollablePopup" id="'+this.id+'"><div class="fullscreen popup" id="i'+this.id+'" style="display:block;"><h3>'+title+'</h3>'+
             '<div class="taWrapper" style="background: transparent;"><div class="popup-top popup-background "></div><div class="popup-bottom popup-background "></div><div class="popup-middle popup-background"><div class="popup-scrollableArea" id="scroll'+this.id+'"><ul id="data'+this.id+'"></ul></div></div>'+innerBody+'</div>'+body+'</div></div>';

     $('body').append(src);
 }

 if(useIscroll){
    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
 }
 else {
     $(window).scroll(function (){
         if(ScrollablePopup.prototype.current){
             var s = $(window).scrollTop();
             $('#scroll'+ScrollablePopup.prototype.current.id).scrollTop(s);
         }
     });
 }

 ScrollablePopup.prototype.current = null;
 ScrollablePopup.prototype.show = function(){
     if(ScrollablePopup.prototype.current) return;
     ScrollablePopup.prototype.current = this;
     if(this.iscroll){
         var s = this.scrollbar = new iScroll('scroll'+this.id,{hScroll:false,hScrollbar:false});
         setTimeout(function() { s.refresh(); },0);
     }
     $('#'+this.id).fadeIn('slow');
     if(!this.iscroll)
         $('#'+this.id).height($('#data'+this.id).height() + 40 + 54 + 32 + 32);
     return this;
 }

 ScrollablePopup.prototype.close = function(){
     var scrollbar = this.scrollbar;
     $('#'+this.id).fadeOut('slow',function(){
         if(scrollbar){
             try{
                 scrollbar.destroy();
             }
             catch(exp){
             }
         }
     });
     this.scrollbar = null;
     ScrollablePopup.prototype.current = null;
     return this;
 }
 ScrollablePopup.prototype.transition = function(other){
      this.close();
      other.show();
 }
 ScrollablePopup.prototype.update= function(data){
     var id = 0;
     var container = $('#data'+this.id);
     var idPrefix=this.id+'_';
     var handler = this.childClick;
     var creator = this.nodeCreator;

     var src = '';

      data.forEach(function(elem){
         src+=creator(elem,idPrefix+id);
         id++;
     });
     container.html(src);
     id = 0;
     if(handler) data.forEach(function(elem){
             $('#'+idPrefix+id).data('id',id).click(function(){
                handler($(this).data('id'));
             });
             id++;
     });
 }
 ScrollablePopup.prototype.child = function(id) {
     return $('#'+this.id+'_'+id);
 }
 ScrollablePopup.prototype.refresh = function(){
     var scrollbar = this.scrollbar;
     if(scrollbar) scrollbar.refresh();
     //if(scrollbar) setTimeout(function(){ scrollbar.refresh(); },0);
 }
 ScrollablePopup.prototype.scrollToBottom = function() {
    if(this.scrollbar){
        var dh=$('#data'+this.id).height();
        var ch=$('#scroll'+this.id).height();
        console.log('Scrolling by s' + dh + ':' + ch + ':' + (dh-ch));
        if(dh>ch) this.scrollbar.scrollTo(0,-(dh-ch),0);
    }
    else {
        var dh=$('#'+this.id).height();
        var ch=$(window).height();
        console.log('Scrolling by' + dh + ':' + ch + ':' + (dh-ch));
        if(dh>ch) $(window).scrollTop(dh-ch);
    }
 }

 //normal popups
 Popup.prototype = new PopupBase;
 Popup.prototype.constructor = PopupBase;
 function Popup(title,body){
     PopupBase.call(this,title,'<div class="popupWrapper">'+body+'</div>');
 }

 //one big textarea popup
 MessagePopup.prototype = new PopupBase;
 MessagePopup.prototype.constructor = PopupBase;
 function MessagePopup(title,buttons,settings){
     settings = settings == null ? {} : settings;
     this.buttons = buttons;

     var extras = settings.readonly ? ' readonly="readonly"' : '';
     PopupBase.call(this,title,'<form><div class="taWrapper"><div class="textareaWrapper"><textarea name="m" id="msg_'+ids+'" maxlength="500" required'+extras+'></textarea></div></div>' +
             '<div class="popup-buttonArea"><input type="button" value="'+buttons[0].text+'" onClick="'+buttons[0].action+';"/>'+
             '<input type="button" value="'+buttons[1].text+'" onClick="'+buttons[1].action+';"/></div></form>');
 }
 MessagePopup.prototype.send = function(url,handler){
     this.close();
     if(handler) $.post(url, $('#msg'+this.id).serialize() ,handler,'json');
     else $.post(url, $('#msg'+this.id).serialize());
     $('#msg'+this.id).val('');
     return this;
 }
 MessagePopup.prototype.setText = function(text){
     $('#msg'+this.id).val(text);
     return this;
 }




 function bottleSent(data){
     if(data.r >= 0){
         bottleCount = data.r;
         $('#btn_bottle_counter').html(bottleCount.toString());
     }
     else alert('Bottle failed sending! Error:' + data.error);
 }

 var welcome = new Popup('Welcome',
         '<p>What is throw a bottle? It is a simple service which allows you to throw anonymous bottles into the sea.</p>' + //'<p>This will be the main welcome page. In here the user will be asked to sign in. We also will have a description and shit</p>' +
         '<button type="button" class="centeredButton" onClick="welcome.transition(signin);">Sign in</button>' +
         '<button type="button" class="centeredButton" onClick="welcome.transition(registration);">Register</button>' +
         '<button type="button" class="centeredButton" id="facebook_signin">Sign in with facebook</button>');

 $('#facebook_signin').click(function(){
     window.location.href = 'https://www.facebook.com/dialog/oauth/?client_id=233473013410744&display='+(mobile ? 'touch' : 'page')+'&redirect_uri=http%3A%2F%2F199.30.59.142%2Fapi%2Ffblogin&response_type=code';
 });

 var signin = new Popup('Log In','<form id="loginForm">' +
         '<label for="userid">User ID:</label>' +
         '<input type="text" id="loginUser" name="userid" required autocapitalize="off"/>' +
          '<label for="password">Password:</label>'+
          '<input type="password" id="loginPassword" name="password" required autocapitalize="off"/>' +
          '<input type="submit" style="float:none;margin:20px auto" value="Log in"/></form>');

 var registration = new Popup('Register','<form id="registrationForm">' +
         '<label for="userid">User ID:</label>' +
         '<input type="text" id="loginUser" name="userid" required autocapitalize="off"/>' +
         '<label for="password">Password:</label>'+
         '<input type="password" id="loginPassword" name="password" required autocapitalize="off"/>' +
         '<input type="submit" style="float:none;margin:20px auto" value="Log in"/></form>');

 var threads = new ScrollablePopup('Messages','<div class="popup-buttonArea"><button type="button" style="float:none;margin:10px auto" onClick="threads.close();">Ok</button></div>');

 //welcome.show();

 threads.childClick = function(id){
     alert('t:'+id);
     var thread = threads.child(id).append('<div class="threadLoader"></div>');
     var recieved = false;
     function messagesRecieved(data){
         if(recieved) return;
         recieved = true;
         $('.threadLoader').remove();
         if(data.r && data.r.length !== 0){
            if(threads.threads[id].e !==0 ) threads.child(id).removeClass('threadNotRead').addClass('threadRead');
             messages.threadId = threads.threads[id].i;
             //data.r.push({last:true});
             messages.update(data.r);
             threads.transition(messages);
             setTimeout(function(){ messages.scrollToBottom() },500);
         }
     }

     setTimeout(function(){ messagesRecieved({r:[{s:0,m:'Hi there!'},{s:1,m:'Hi yourself'},{s:0,m:'Hi oo<br>jshjls'},{s:1,m:'F.U'},{s:0,m:'Pop pop!'}]}); },2000);
     $.get('api/messages?i='+threads.threads[id].i,messagesRecieved,'json');
 }

 threads.nodeCreator = function(thread,id){
     return '<li class="thread '+(thread.e==0?'threadRead':'threadNotRead')+'" id="'+id+'">'+(thread.s==1?'<div class="threadArrowHead"></div><div class="threadArrow"></div>':'')+'<span>'+thread.m+'</span></li>';
 }

 var messages = new ScrollablePopup('Messages','<div class="popup-buttonArea"><button type="button" onClick="messages.transition(threads);">back</button><button type="button" onClick="messages.showReply();">Reply</button></div>',
 '<div class="message-reply" id="replyToMessage"><div><textarea></textarea></div></div>');

 messages.nodeCreator = function(message,id){
    if(message.last)
        return 'Reply:<br></span></span><textarea name="m" id="foo" maxlength="500"></textarea><input type="text">'
    else return '<li><div class="message '+(message.s==1?'message-sender':'message-reciever')+'"><p>'+message.m+'</p></div></li>';
 }
 messages.showReply = function() {
     //$('#scroll'+messages.id).removeClass('popup-scrollableArea').addClass('popup-scrollableArea-raised');
     $('#scroll'+messages.id).animate({bottom:"40%"},1000,'linear',function(){
         messages.refresh();
         messages.scrollToBottom();
     });
     $('#replyToMessage').animate({height:'40%'},1000,'linear');
 }



 function messagesRecieved(data){
     if(data.r && data.r.length !== 0){
         //data.r.push({last:true});
         messages.update(data.r);
         messages.show();
         setTimeout(function(){ messages.scrollToBottom() },500);
     }
 }
 messagesRecieved({r:[{s:0,m:'Hi there!'},{s:1,m:'Hi yourself'},{s:0,m:'Hi oo<br>jshjls'},{s:1,m:'F.U'},{s:0,m:'Pop pop!'}]});



 $('#loginForm').submit(function(){
     var userid = $('#loginUser').val();
     var password = $('#loginPassword').val();
     $.post('api/login','userid='+userid+'&pwd='+password,function(response){
         if(response.r === 0){
             handleQuery(response);
             signin.close();
         }
         else alert('Wrong username or password!');
     },'json');
     return false;
 });

 $('#registrationForm').submit(function(){
     var userid = $('#loginUser').val();
     var password = $('#loginPassword').val();
     $.post('api/register','userid='+userid+'&pwd='+password,function(response){
         if(response.r === 0){
             handleQuery(response);
             registration.close();
         }
         else alert('This username is already taken!');
     },'json');
     return false;
 });


 var newBottle = new MessagePopup('Say something:',[{text:'never mind',action:'newBottle.close()'},{text:'throw!',action:'$(\'#btn_bottle_counter\').html((bottleCount-1).toString());newBottle.send(\'api/throw\',bottleSent)'}]);

 var recievedBottle = new MessagePopup('Bottle:',[{text:'throw back',action:'recievedBottle.close();$.get(\'api/bottle/recycle\');'},{text:'reply',action:'recievedBottle.transition(replyToBottle)'}],{readonly:true});

 var replyToBottle = new MessagePopup('Reply:',[{text:'cancel',action:'replyToBottle.close();$.get(\'api/bottle/recycle\');'},{text:'send reply',action:'replyToBottle.send(\'api/bottle/reply\')'}]);

 $('#btn_bottle').click(function(){
     if(bottleCount === 0) alert('No more bottles remaining!');
     else newBottle.show();
 });

 $('#btn_net').click(function(){
     function bottleCaught(data){
         if(data.r >= 0){
             netCount = data.r;
             if(data.m){
                 $('#btn_net_counter').html(netCount.toString());
                 recievedBottle.setText(data.m).show();
             }else alert("You've caught some " + data.j);
         }
         else alert('Bottle failed catching! Error:' + data.error);
     }

     if(netCount === 0) alert('No more nets remaining!');
     else{
         $('#btn_net_counter').html((netCount-1).toString());
         $.get('api/catch',bottleCaught,'json');
     }
 });


 var notifications = $('#notifications');
 notifications.count = function(n){
     if(n > 0){
         this.html(n.toString());
         this.show();
     }else this.hide();
 }

 $('#btn_history').click(function(){
     var recieved = false;
     function threadsRecieved(data){
         if(recieved) return;
         recieved = true;
         if(data.r && data.r.length !== 0){
             threads.threads = data.r;
             threads.update(data.r);
             threads.show();
         }
     }
     $.get('api/threads',threadsRecieved,'json');

     setTimeout(function(){ threadsRecieved({r:[{i:1,s:0,e:1,m:'foo'},{i:2,s:1,e:1,m:'bar'},{i:3,s:0,e:0,m:'kR%H H JR%\n5uytrjhgr rggh\nrgjhr rjghj5hjg 5jhghj\n5uytrjhgr rggh rgjhr rjghj5hjg 5jhghj'},{i:4,s:1,e:1,m:'lol'},{i:5,s:0,e:0,m:'test'},{i:6,s:1,e:1,m:'lol'},{i:7,s:0,e:0,m:'test'}]}); },
         2000);
 });

 function handleQuery(response){
     if(response.r === 0){
         bottleCount = response.b;
         $('#btn_bottle_counter').html(bottleCount.toString());
         netCount = response.n;
         $('#btn_net_counter').html(netCount.toString());
         notifications.count(response.e ? response.e : 0);
     }
     else welcome.show();
 }

 //poll the server for updates
 var isActive = true;
 window.onfocus = function () {
     isActive = true;
 }
 window.onblur = function () {
     isActive = false;
 }
 function query(){
     if(isActive){
        $.get('api/query',handleQuery);
     }
     setTimeout(query,5 * 60 * 1000);
 }

 $(document).ready(function(){
     query();

 });


</script>

</body>
</html>


